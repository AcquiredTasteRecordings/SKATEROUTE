# SKATEROUTE — Elite iOS CI for a downhill-first skateboard navigation app.
# Goals:
#  • High-signal PRs (lint, tests, coverage) across iOS 17/18.
#  • Deterministic Release archives on main/tags.
#  • Artifacts for debugging: xcresult, coverage, dSYMs, .app packaging.
#  • Fast, reliable (SPM + DerivedData caching, concurrency, fail-fast).

name: iOS CI (SKATEROUTE)

on:
  workflow_dispatch:
    inputs:
      run_archive:
        description: "Also produce Release archive (unsigned)"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read
  checks: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: "16.4"
  PROJECT: "SKATEROUTE.xcodeproj"
  SCHEME: "SKATEROUTE"
  DERIVED_DATA: "${{ runner.temp }}/DerivedData"
  RESULT_BUNDLE: "build/ci.xcresult"

jobs:
  lint:
    name: Lint & Static Checks
    runs-on: macos-14
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: |
          sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app" || \
          sudo xcode-select -s "/Applications/Xcode.app"
          xcodebuild -version

      - name: Lint localizations
        run: |
          set -euo pipefail
          find Resources/Strings -name "*.strings" -print0 | xargs -0 plutil -lint
          plutil -lint Resources/Strings/Localizable.stringsdict
          # Placeholder sanity: ensure matching %@ / %d between base and stringsdict doesn’t regress
          grep -E '%[@d]' Resources/Strings/Localizable.strings || true

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve Packages (sanity)
        run: |
          set -eo pipefail
          xcodebuild -resolvePackageDependencies \
            -project "$PROJECT" | xcpretty || true

      - name: Install Linting Tooling
        run: |
          brew update >/dev/null
          brew install swiftlint swiftformat xcbeautify || true

      - name: SwiftLint (strict, non-blocking)
        continue-on-error: true
        run: swiftlint --strict

      - name: SwiftFormat (lint only)
        continue-on-error: true
        run: swiftformat --lint .

  test:
    name: Build & Test (iOS Simulator Matrix)
    runs-on: macos-14
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: ["18.5", "17.5"]
        device: ["iPhone 16 Pro"]
    env:
      IOS_SIM_OS: ${{ matrix.os }}
      IOS_SIM_DEVICE: ${{ matrix.device }}
    timeout-minutes: 50
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: |
          sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app" || \
          sudo xcode-select -s "/Applications/Xcode.app"
          xcodebuild -version

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ${{ env.DERIVED_DATA }}
          key: ${{ runner.os }}-deriveddata-${{ github.sha }}
          restore-keys: ${{ runner.os }}-deriveddata-

      - name: Build & Test (with coverage)
        env:
          NSUnbufferedIO: "YES"
        run: |
          set -eo pipefail
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,OS=${IOS_SIM_OS},name=${IOS_SIM_DEVICE}" \
            -derivedDataPath "${DERIVED_DATA}" \
            -enableCodeCoverage YES \
            clean test \
            -resultBundlePath "${RESULT_BUNDLE}" \
            | xcbeautify --is-ci

      - name: Export Coverage (xccov)
        if: always()
        run: |
          mkdir -p build
          xcrun xccov view --report --json "${RESULT_BUNDLE}" > build/coverage-${{ matrix.os }}.json || true
          xcrun xccov view --report "${RESULT_BUNDLE}" || true

      - name: Upload xcresult & Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcresult-and-coverage-${{ matrix.os }}
          path: |
            ${{ env.RESULT_BUNDLE }}
            build/coverage-${{ matrix.os }}.json
          retention-days: 14

  archive:
    name: Archive (Release, unsigned)
    if: github.ref == 'refs/heads/main' || inputs.run_archive == 'true' || startsWith(github.ref, 'refs/tags/v')
    runs-on: macos-14
    needs: test
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: |
          sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app" || \
          sudo xcode-select -s "/Applications/Xcode.app"
          xcodebuild -version

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Archive (CODE_SIGNING_ALLOWED=NO)
        run: |
          set -eo pipefail
          ARCHIVE_PATH="$PWD/build/SKATEROUTE.xcarchive"
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -derivedDataPath "${DERIVED_DATA}" \
            CODE_SIGNING_ALLOWED=NO \
            clean archive \
            -archivePath "$ARCHIVE_PATH" | xcbeautify --is-ci
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

      - name: Package dSYMs & App
        run: |
          mkdir -p build/export
          if [ -d "$ARCHIVE_PATH/dSYMs" ]; then
            /usr/bin/zip -qry build/export/SKATEROUTE.dSYMs.zip "$ARCHIVE_PATH/dSYMs"
          fi
          if [ -d "$ARCHIVE_PATH/Products/Applications" ]; then
            /usr/bin/zip -qry build/export/SKATEROUTE.app.zip "$ARCHIVE_PATH/Products/Applications/SKATEROUTE.app"
          fi

      - name: Upload Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: archive-artifacts
          path: |
            build/SKATEROUTE.xcarchive
            build/export/SKATEROUTE.dSYMs.zip
            build/export/SKATEROUTE.app.zip
          retention-days: 14

  codecov:
    name: Coverage Upload (Codecov) — optional
    if: always() && secrets.CODECOV_TOKEN != ''
    runs-on: macos-14
    needs: test
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: xcresult-and-coverage-18.5
          path: coverage
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: "coverage/build/coverage-18.5.json"
          flags: ios
          verbose: false

  danger:
    name: Danger (Swift) — optional
    if: github.event_name == 'pull_request' && secrets.DANGER_GITHUB_API_TOKEN != ''
    runs-on: macos-14
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Install Danger-Swift
        run: brew install danger/tap/danger-swift || true
      - name: Run Danger
        env:
          DANGER_GITHUB_API_TOKEN: ${{ secrets.DANGER_GITHUB_API_TOKEN }}
        run: danger-swift ci

# Notes:
# • Works with Xcode 16.4 runners; update XCODE_VERSION when you bump locally.
# • To produce signed IPAs/TestFlight from CI, add Fastlane plus App Store Connect API keys
#   (APP_STORE_CONNECT_ISSUER_ID, KEY_ID, PRIVATE_KEY base64) and extend `archive` with export.
# • Simulator matrix runs on iOS 18.5 and 17.5 for forward/back-compat.
# • Artifacts (xcresult, dSYMs, app) retained 14 days for triage.
