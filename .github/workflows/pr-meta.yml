name: PR metadata & hygiene

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
  pull_request_target:
    types: [opened, synchronize, reopened, edited, ready_for_review]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-meta-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  label:
    name: Auto-label by file globs
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: true
          configuration-path: .github/labeler.yml

  auto-assign:
    name: Auto-assign reviewers/assignees
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - uses: kentaro-m/auto-assign-action@v2.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/auto_assign.yml

  validate-template:
    name: Validate PR description template
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Fail if required sections are missing
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request.body || "").trim();
            const required = [
              "## 1) Summary (What)",
              "## 2) Context & Why (User Value / Problem)",
              "## 3) Technical Approach (How)",
              "## 4) Risk, Tradeoffs & Mitigations",
              "## 5) Testing",
              "## 6) Performance, Battery & Memory",
              "## 7) Privacy, Permissions & Compliance",
              "## 8) Accessibility & Localization",
              "## 9) Security",
              "## 10) Analytics / Telemetry",
              "## 11) Screenshots / Videos / Diffs",
              "## ✅ Merge Checklist"
            ];
            const missing = required.filter(h => !body.includes(h));
            if (missing.length) {
              core.setFailed(`PR description is missing sections: ${missing.join(" | ")}`);
            }

      - name: Comment with missing sections (if any)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request.body || "").trim();
            const required = [
              "## 1) Summary (What)",
              "## 2) Context & Why (User Value / Problem)",
              "## 3) Technical Approach (How)",
              "## 4) Risk, Tradeoffs & Mitigations",
              "## 5) Testing",
              "## 6) Performance, Battery & Memory",
              "## 7) Privacy, Permissions & Compliance",
              "## 8) Accessibility & Localization",
              "## 9) Security",
              "## 10) Analytics / Telemetry",
              "## 11) Screenshots / Videos / Diffs",
              "## ✅ Merge Checklist"
            ];
            const missing = required.filter(h => !body.includes(h));
            const md = [
              `Thanks for the PR! I couldn't find the following sections in your description:`,
              missing.map(s => `- ${s}`).join("\\n"),
              ``,
              `Please update the PR body using the template in .github/pull_request_template.md.`
            ].join("\\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: md
            });

  title-lint:
    name: Lint PR title (conventional commits)
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            perf
            refactor
            docs
            test
            ci
            chore
          scopes: |
            map
            routing
            telemetry
            ui
            infra
            release

  size-label:
    name: Apply size/* label
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_max_size: '50'
          s_max_size: '150'
          m_max_size: '400'
          l_max_size: '800'
          fail_if_xl: 'false'

  check-sensitive-files:
    name: Prevent risky changes without 'security-reviewed' label
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base + PR HEAD
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Block risky diffs unless labeled
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const {data: files} = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 300
            });
            const risky = files.filter(f =>
              /PrivacyInfo\.xcprivacy|Info\.plist|SKATEROUTE\/Services\/LocationManagerService\.swift|\.github\/workflows\//.test(f.filename)
            );
            const hasLabel = (pr.labels || []).some(l => l.name === 'security-reviewed');
            if (risky.length && !hasLabel) {
              const names = risky.map(f => f.filename).join("\\n- ");
              core.setFailed(
                `Risky files changed without 'security-reviewed' label:\\n- ${names}\\n` +
                `Add the label after review to proceed.`
              );
            }

name: PR Meta & Hygiene
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited
      - labeled
      - unlabeled
      - ready_for_review
      - review_requested
      - converted_to_draft

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

# Minimal, principled permissions. Jobs override as needed.
permissions:
  contents: read
  pull-requests: write
  issues: write
  repository-projects: write

jobs:
  # 1) Auto-label based on paths + add size labels
  label:
    name: Auto-label & size
    if: ${{ github.event.pull_request }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Apply labels from paths
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: true

      - name: Add size label (XS/S/M/L/XL)
        uses: pascalgn/size-label-action@v0.5.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Ignore assets/locks so size reflects code impact
          IGNORED: >
            **/*.xcassets/**
            **/*.png
            **/*.jpg
            **/*.jpeg
            **/*.pdf
            **/*.gif
            **/*.mov
            **/*.mp4
            Podfile.lock
            Cartfile.resolved
            Package.resolved
            yarn.lock
            package-lock.json
          SIZES: >
            {"0":"size: XS","100":"size: S","500":"size: M","1000":"size: L","2000":"size: XL"}

  # 2) Auto-assign reviewers/assignees from .github/auto_assign.yml (CODEOWNERS-friendly)
  reviewers:
    name: Auto-assign reviewers
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: kentaro-m/auto-assign@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          # Configure behavior via .github/auto_assign.yml:
          # addReviewers: true
          # addAssignees: false
          # numberOfReviewers: 2
          # reviewers:
          #   - reviewer1
          #   - reviewer2

  # 3) Enforce PR title format (Conventional Commits) for clean history & release notes
  title-lint:
    name: Lint PR title (Conventional)
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Allow common types we use
          types: |
            feat
            fix
            chore
            docs
            refactor
            perf
            test
            build
            ci
            revert
          # Encourage (optional) scopes that match our architecture
          scopes: |
            map
            routing
            telemetry
            ux
            infra
            docs
          requireScope: false
          # Keep subjects short, action-oriented
          subjectPattern: ^(?![A-Z]).+
          subjectPatternError: "Use imperative, lowercase subject (e.g. 'feat(map): add braking dashes')."

  # 4) Validate PR body follows our template and has at least one checked item
  body-guardrails:
    name: Validate PR body & checklist
    runs-on: ubuntu-latest
    steps:
      - name: Verify required sections exist
        shell: bash
        run: |
          BODY="${{ github.event.pull_request.body }}"
          missing=()
          for h in "## What" "## Why" "## How" "## Screenshots / Diffs" "## Checklist"; do
            echo "$BODY" | grep -E "$h" >/dev/null || missing+=("$h")
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error title=PR template incomplete::Missing sections: ${missing[*]}"
            exit 1
          fi

      - name: Require at least one checklist item checked
        uses: mheap/require-checklist@v2
        with:
          requireAll: false
          message: "Please check at least one item in the PR checklist."

  # 5) Ensure PR has a type AND an area label (two passes)
  require-labels:
    name: Require labels (type & area)
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Require a type: label
        uses: jesusvasquez333/verify-pr-label@v1.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          valid-labels: >
            type: feature,type: bug,type: chore,type: docs,type: refactor,type: perf,type: test
      - name: Require an area: label
        uses: jesusvasquez333/verify-pr-label@v1.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          valid-labels: >
            area: map,area: routing,area: telemetry,area: ux,area: infra,docs

  # 6) (Optional) Add PRs to a GitHub Project (Roadmap) if secrets provided
  project:
    name: Add to roadmap project (optional)
    if: ${{ secrets.PROJECT_URL != '' && github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    permissions:
      repository-projects: write
      contents: read
      pull-requests: read
    steps:
      - name: Add to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: ${{ secrets.PROJECT_URL }}
          github-token: ${{ secrets.GH_PROJECT_TOKEN || secrets.GITHUB_TOKEN }}

# Notes:
# - Configure labels by file path in .github/labeler.yml (we provided a robust template earlier).
# - Configure auto-assign behavior in .github/auto_assign.yml or CODEOWNERS.
# - If you don't use Projects, omit the "project" job or leave PROJECT_URL unset.
# - All jobs run on PR events and fail fast with actionable errors when metadata is missing.
